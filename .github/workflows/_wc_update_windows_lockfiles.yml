on:
  workflow_call:
    inputs:
      ref:
        description: The branch, tag or SHA to checkout
        required: true
        type: string
      environment:
        description: Environment to execute the workflow in
        type: string
        required: true
    outputs:
      sha:
        description: Git SHA checked out after updates
        value: ${{ jobs.update_windows_lockfiles.outputs.sha }}
permissions:
  actions: write
  contents: write
concurrency:
  group: ci-update-windows-lockfiles-${{ inputs.ref }}
  cancel-in-progress: true
env:
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
jobs:
  update_windows_lockfiles:
    name: Update Windows lock files
    runs-on: windows-latest
    environment: ${{ inputs.environment }}
    outputs:
      sha: ${{ steps.result_sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0
      - name: Detect changes in linux-specific lock files
        id: changed-linux-lockfiles
        uses: tj-actions/changed-files@v47
        with:
          since_last_remote_commit: true
          files: |
            src/**/packages.lock.json
            tests/**/packages.lock.json
      - name: Ensure NUGET_PACKAGES exists
        if: ${{ steps.changed-linux-lockfiles.outputs.any_changed == 'true' }}
        run: |
          if (!(Test-Path -PathType container $env:NUGET_PACKAGES))
          {
            New-Item -ItemType Directory -Force -Path $env:NUGET_PACKAGES
          }
      - name: Setup dotnet
        if: ${{ steps.changed-linux-lockfiles.outputs.any_changed == 'true' }}
        uses: actions/setup-dotnet@v5
        with:
          cache: true
          cache-dependency-path: |
            **/packages.win.lock.json
          global-json-file: global.json
      - name: Generate windows lock files if needed
        if: ${{ steps.changed-linux-lockfiles.outputs.any_changed == 'true' }}
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-linux-lockfiles.outputs.all_changed_files }}
        run: |
          foreach ($file in $env:ALL_CHANGED_FILES -split " ") {
              # Get the directory containing the file
              $directory = Split-Path $file -Parent
              
              # Find the first .csproj file in that directory
              $proj = Get-ChildItem -Path $directory -Filter *.csproj -File | 
                      Select-Object -First 1 -ExpandProperty FullName
              
              if ($proj) {
                  Write-Host "Restoring project $proj for win-x64"
                  dotnet restore $proj --force-evaluate
              }
          }
      - name: Publish updated windows lock files
        if: ${{ steps.changed-linux-lockfiles.outputs.any_changed == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: update windows lock files"

      - name: Export resulting SHA
        id: result_sha
        if: ${{ always() }}
        shell: pwsh
        run: |
          "sha=$(git rev-parse HEAD)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
