@using RestoRate.RestaurantService.Application.UseCases.Tags
@using RestoRate.SharedKernel.Enums
@using MudBlazor
@using RestoRate.Contracts.Restaurant.DTOs
@using RestoRate.BlazorDashboard.Services
@inject RestaurantWebService RestaurantService

<MudPaper Class="rr-cloud pa-6 mb-6" Elevation="2">
    <MudGrid Spacing="3">

        <MudItem xs="12" lg="5">
            <MudAutocomplete T="string"
                             Label="Поиск по названию..."
                             Value="searchTerm"
                             TextChanged="OnSearchChanged"
                             SearchFunc="@SearchRestaurants"
                             ResetValueOnEmptyText="true"
                             Clearable="true"
                             Variant="Variant.Filled"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             DebounceInterval="500"
                             MaxItems="10"
                             Class="filter-input" />
        </MudItem>

        <MudItem xs="12" lg="3">
            <MudSelect T="string"
                       Label="Кухня"
                       Value="selectedCuisineName"
                       ValueChanged="OnCuisineChanged"
                       Variant="Variant.Filled"
                       Clearable="true"
                       AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="string" Value="@(null)">Все кухни</MudSelectItem>
                @foreach (var cuisine in CuisineType.List.OrderBy(c => c.RussianName))
                {
                    <MudSelectItem T="string" Value="@cuisine.Name">@cuisine.RussianName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" lg="3">
            @if (_tags == null)
            {
                <MudSkeleton Width="100%" Height="56px" />
            }
            else
            {
                <MudSelect T="string"
                           Label="Тэги"
                           Value="selectedTag"
                           ValueChanged="OnTagChanged"
                           Variant="Variant.Filled"
                           Clearable="true"
                           AnchorOrigin="Origin.BottomCenter">

                    <MudSelectItem T="string" Value="@((string?)null)">Все тэги</MudSelectItem>

                    @foreach (var tag in _tags)
                    {
                        <MudSelectItem T="string" Value="@tag.Name">@tag.Name</MudSelectItem>
                    }
                </MudSelect>
            }
        </MudItem>

        <MudItem xs="12" lg="1" Class="d-flex align-center justify-end">
            <MudButton Variant="Variant.Text" Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.RestartAlt"
                       Size="Size.Small" OnClick="ResetFilters">
                Сброс
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public EventCallback OnFiltersChanged { get; set; }

    private string? searchTerm;
    private string? selectedCuisineName;
    private string? selectedTag;
    private List<TagDto>? _tags;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tags = await RestaurantService.GetTagsAsync();
        }
        catch
        {
            _tags = new();
        }
    }

    private Task<IEnumerable<string>> SearchRestaurants(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult<IEnumerable<string>>(Array.Empty<string>());
        return Task.FromResult<IEnumerable<string>>(new[] { value });
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task OnCuisineChanged(string value)
    {
        selectedCuisineName = value;
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task OnTagChanged(string? value)
    {
        selectedTag = value;
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task ResetFilters()
    {
        searchTerm = null;
        selectedCuisineName = null;
        selectedTag = null;
        await OnFiltersChanged.InvokeAsync();
    }

    public (string? SearchTerm, string? CuisineType, string? Tag) GetFilters()
    {
        return (searchTerm, selectedCuisineName, selectedTag);
    }
}
