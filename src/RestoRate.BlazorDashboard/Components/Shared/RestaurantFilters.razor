@using RestoRate.Contracts.Common.Dtos
@using RestoRate.RestaurantService.Application.UseCases.Tags
@using RestoRate.SharedKernel.Enums
@using MudBlazor
@using RestoRate.Contracts.Restaurant.DTOs
@using RestoRate.BlazorDashboard.Services
@inject RestaurantWebService RestaurantService

<MudPaper Class="filter-container pa-6 mb-8" Elevation="0">
    <MudGrid Spacing="3" Class="align-center">

        <MudItem xs="12" md="5">
            <MudAutocomplete T="string"
                             Label="Поиск ресторана"
                             Value="searchTerm"
                             ValueChanged="OnSearchChanged"
                             SearchFunc="@SearchRestaurants"
                             ResetValueOnEmptyText="true"
                             Clearable="true"
                             Variant="Variant.Outlined"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             AdornmentColor="Color.Primary"
                             DebounceInterval="500"
                             MaxItems="10"
                             Class="rr-input"
                             Placeholder="Название, например 'Мама Рома'" />
        </MudItem>

        <MudItem xs="12" md="3">
            <MudSelect T="string"
                       Label="Кухня"
                       Value="selectedCuisineName"
                       ValueChanged="OnCuisineChanged"
                       Variant="Variant.Outlined"
                       Clearable="true"
                       AdornmentColor="Color.Primary"
                       AnchorOrigin="Origin.BottomLeft"
                       TransformOrigin="Origin.TopLeft"
                       Class="rr-input">
                <MudSelectItem T="string" Value="@(null)">Все кухни</MudSelectItem>
                @foreach (var cuisine in CuisineType.List.OrderBy(c => c.RussianName))
                {
                    <MudSelectItem T="string" Value="@cuisine.Name">@cuisine.RussianName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="3">
            @if (_tags == null)
            {
                <MudSkeleton Width="100%" Height="56px" Class="rounded-pill" />
            }
            else
            {
                <MudSelect T="string"
                           Label="Настроение / Теги"
                           Value="selectedTag"
                           ValueChanged="OnTagChanged"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           AdornmentColor="Color.Primary"
                           AnchorOrigin="Origin.BottomLeft"
                           TransformOrigin="Origin.TopLeft"
                           Class="rr-input">

                    <MudSelectItem T="string" Value="@((string?)null)">Любое</MudSelectItem>

                    @foreach (var tag in _tags)
                    {
                        <MudSelectItem T="string" Value="@tag.Name">@tag.Name</MudSelectItem>
                    }
                </MudSelect>
            }
        </MudItem>

        <MudItem xs="12" md="1" Class="d-flex justify-start pl-2">
            <MudTooltip Text="Сбросить все фильтры">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                               Color="Color.Secondary"
                               Variant="Variant.Filled"
                               OnClick="ResetFilters"
                               Class="refresh-btn shadow-sm" />
            </MudTooltip>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public EventCallback OnFiltersChanged { get; set; }

    private string? searchTerm;
    private string? selectedCuisineName;
    private string? selectedTag;
    private List<TagDto>? _tags;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tags = await RestaurantService.GetTagsAsync();
        }
        catch
        {
            _tags = new();
        }
    }

    public async Task SetValues(string? search, string? cuisine)
    {
        searchTerm = search;
        selectedCuisineName = cuisine;
        StateHasChanged();
    }

    private Task<IEnumerable<string>> SearchRestaurants(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult<IEnumerable<string>>(Array.Empty<string>());
        return Task.FromResult<IEnumerable<string>>(new[] { value });
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task OnCuisineChanged(string value)
    {
        selectedCuisineName = value;
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task OnTagChanged(string? value)
    {
        selectedTag = value;
        await OnFiltersChanged.InvokeAsync();
    }

    public async Task ResetFilters()
    {
        searchTerm = null;
        selectedCuisineName = null;
        selectedTag = null;
        await OnFiltersChanged.InvokeAsync();
    }

    public (string? SearchTerm, string? CuisineType, string? Tag) GetFilters()
    {
        return (searchTerm, selectedCuisineName, selectedTag);
    }
}
