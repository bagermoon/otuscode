@using RestoRate.Contracts.Restaurant.DTOs
@using RestoRate.Contracts.Review.Dtos
@using RestoRate.Contracts.Common.Dtos
@using RestoRate.BlazorDashboard.Services
@using RestoRate.BlazorDashboard.Helpers
@using RestoRate.SharedKernel.Enums
@using System.Globalization
@using System.Security.Claims
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization

@inject RestaurantWebService RestaurantService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog Class="rr-modern-dialog" ContentClass="pa-0 dialog-wrapper">
    <DialogContent>

        <div class="hero-header relative">
            <div class="rr-custom-btn close-pos" @onclick="Close">
                <MudIcon Icon="@Icons.Material.Filled.Close" />
            </div>

            <MudCarousel Class="rr-carousel full-height" @bind-SelectedIndex="_selectedIndex" ShowArrows="true" ShowBullets="false" EnableSwipeGesture="true" AutoCycle="false" TData="object">
                <PreviousButtonTemplate>
                    <div class="rr-custom-btn nav-arrow left" @onclick="PrevImage" @onclick:stopPropagation="true">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowBackIosNew" />
                    </div>
                </PreviousButtonTemplate>
                <NextButtonTemplate>
                    <div class="rr-custom-btn nav-arrow right" @onclick="NextImage" @onclick:stopPropagation="true">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowForwardIos" />
                    </div>
                </NextButtonTemplate>
                <ChildContent>
                    @if (Restaurant.Images != null && Restaurant.Images.Any())
                    {
                        @foreach (var img in Restaurant.Images)
                        {
                            <MudCarouselItem Transition="Transition.Fade" Class="full-height carousel-item-no-padding">
                                <div class="carousel-image" style="background-image: url('@img.Url')"></div>
                            </MudCarouselItem>
                        }
                    }
                    else
                    {
                        <MudCarouselItem Class="full-height carousel-item-no-padding">
                            <div class="carousel-image d-flex align-center justify-center bg-gray-200">
                                <MudIcon Icon="@Icons.Material.Filled.Restaurant" Size="Size.Large" Color="Color.Default" />
                            </div>
                        </MudCarouselItem>
                    }
                </ChildContent>
            </MudCarousel>

            <div class="hero-overlay-gradient">
                <div class="hero-text-content pa-6 pa-md-8">
                    <MudText Typo="Typo.h3" Class="font-weight-bold mb-1" Style="color: #ffffff !important; text-shadow: 0 2px 10px rgba(0,0,0,0.9);">
                        @Restaurant.Name
                    </MudText>
                    @if (Restaurant.CuisineTypes != null && Restaurant.CuisineTypes.Any())
                    {
                        var displayCuisines = Restaurant.CuisineTypes.Take(4);
                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold" Style="color: #ffffff !important; text-shadow: 0 2px 8px rgba(0,0,0,0.9);">
                            @string.Join(" • ", displayCuisines)
                        </MudText>
                    }
                </div>
            </div>
        </div>

        <div class="pa-6 pa-md-8 pt-6">
            <MudGrid Spacing="5">
                <MudItem xs="12" md="7" lg="8">
                    <MudText Typo="Typo.h5" Class="mb-4 font-weight-bold" Color="Color.Primary">Теги</MudText>
                    <div class="d-flex flex-wrap gap-2 mb-6">
                        @if (Restaurant.Tags?.Any() == true)
                        {
                            foreach (var tag in Restaurant.Tags)
                            {
                                <MudChip T="string" Variant="Variant.Outlined" Class="rr-chip font-weight-bold">#@tag</MudChip>
                            }
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Restaurant.Description))
                    {
                        <MudText Typo="Typo.h6" Class="mb-2 font-weight-bold" Color="Color.Primary">О ресторане</MudText>
                        <MudText Typo="Typo.body1" Class="text-secondary lh-lg mb-8" Style="white-space: pre-line; font-size: 1.1rem;">
                            @Restaurant.Description
                        </MudText>
                    }

                    <MudDivider Class="mb-6" />

                    <AuthorizeView>
                        <Authorized>
                            @if (_myExistingReview != null)
                            {
                                <MudText Typo="Typo.h6" Class="mb-4 font-weight-bold" Color="Color.Success">Ваш отзыв</MudText>
                                <MudPaper Elevation="0" Class="pa-6 rounded-xl mb-8 border-success-light">
                                    <div class="d-flex justify-space-between align-start">
                                        <div class="d-flex align-center">
                                            <MudRating SelectedValue="(int)_myExistingReview.Rating" ReadOnly="true" Size="Size.Large" FullIcon="@Icons.Material.Filled.Star" />
                                            <MudText Typo="Typo.caption" Class="ml-2 text-secondary">@_myExistingReview.CreatedAt.ToString("d MMMM yyyy")</MudText>
                                        </div>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Вы уже оценили это место</MudChip>
                                    </div>

                                    <MudText Typo="Typo.body1" Class="mt-3 font-weight-medium">@_myExistingReview.Comment</MudText>

                                    @if (_myExistingReview.AverageCheck != null)
                                    {
                                        <div class="d-flex align-center mt-3">
                                            <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Small" Color="Color.Success" Class="mr-1" />
                                            <MudText Typo="Typo.body2" Class="text-success font-weight-bold">
                                                Потрачено: @_myExistingReview.AverageCheck.Amount.ToString("N0") ₽
                                            </MudText>
                                        </div>
                                    }
                                </MudPaper>
                            }
                            else
                            {
                                <MudText Typo="Typo.h6" Class="mb-4 font-weight-bold" Color="Color.Primary">Оставить отзыв</MudText>
                                <MudPaper Elevation="0" Class="review-form-panel pa-6 rounded-xl mb-8">
                                    <div class="d-flex flex-column gap-4">
                                        <div>
                                            <MudText Typo="Typo.caption" Class="text-secondary mb-1">Ваша оценка</MudText>
                                            <MudRating @bind-SelectedValue="_reviewRating" Size="Size.Large" HoveredColor="Color.Warning" FullIcon="@Icons.Material.Filled.Star" EmptyIcon="@Icons.Material.Filled.StarBorder" />
                                            @if (_reviewRating == 0)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Error">Пожалуйста, поставьте оценку</MudText>
                                            }
                                        </div>

                                        <MudNumericField @bind-Value="_userAverageCheck" Label="Сколько вы потратили? (₽)" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.CurrencyRuble" HideSpinButtons="true" Class="mb-2" />
                                        <MudTextField @bind-Value="_reviewComment" Label="Ваш комментарий" Variant="Variant.Outlined" Lines="3" Counter="500" MaxLength="500" Placeholder="Расскажите, что вам понравилось..." />

                                        <div class="d-flex justify-end mt-2">
                                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitReviewAsync" Disabled="_isSubmitting" Class="rounded-pill px-6 font-weight-bold">
                                                @if (_isSubmitting)
                                                {
                                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                                    <MudText Class="ms-2">Отправка...</MudText>
                                                }
                                                else
                                                {
                                                    <MudText>Опубликовать</MudText>
                                                }
                                            </MudButton>
                                        </div>
                                    </div>
                                </MudPaper>
                            }
                        </Authorized>
                        <NotAuthorized>
                            <MudPaper Elevation="0" Class="review-login-panel pa-6 rounded-xl d-flex flex-column align-center justify-center text-center mb-8">
                                <MudIcon Icon="@Icons.Material.Filled.LockPerson" Size="Size.Large" Class="text-secondary mb-3" />
                                <MudText Typo="Typo.h6" Class="font-weight-bold">Войдите, чтобы оставить отзыв</MudText>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="authentication/login" Class="rounded-pill px-6 mt-3">Войти в аккаунт</MudButton>
                            </MudPaper>
                        </NotAuthorized>
                    </AuthorizeView>

                    <MudText Typo="Typo.h6" Class="mb-4 font-weight-bold" Color="Color.Primary">Отзывы гостей</MudText>

                    @if (_reviews == null)
                    {
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Small" />
                    }
                    else if (!_reviews.Any())
                    {
                        <MudText Typo="Typo.body2" Class="text-secondary">Пока нет отзывов. Будьте первым!</MudText>
                    }
                    else
                    {
                        <div class="reviews-scroll-container">
                            @foreach (var review in _reviews)
                            {
                                if (_currentUserId != null && review.UserId == _currentUserId) continue;

                                <MudPaper Elevation="0" Class="pa-4 mb-4 rounded-xl border-gray">
                                    <div class="d-flex align-center mb-2">
                                        <MudAvatar Color="Color.Secondary" Size="Size.Small" Class="mr-3">
                                            @(review.User?.FullName?.FirstOrDefault().ToString() ?? "?")
                                        </MudAvatar>
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Class="font-weight-bold">
                                                @(review.User?.FullName ?? "Гость")
                                            </MudText>
                                            <div class="d-flex align-center">
                                                <MudRating SelectedValue="(int)review.Rating" ReadOnly="true" Size="Size.Small" />
                                                <MudText Typo="Typo.caption" Class="ml-2 text-secondary">
                                                    @review.CreatedAt.ToString("d MMM yyyy")
                                                </MudText>
                                            </div>
                                        </div>
                                    </div>

                                    <MudText Typo="Typo.body2" Class="mb-2">@review.Comment</MudText>

                                    @if (review.AverageCheck != null)
                                    {
                                        <MudText Typo="Typo.caption" Class="text-secondary font-weight-bold">
                                            Чек: @review.AverageCheck.Amount.ToString("N0") ₽
                                        </MudText>
                                    }
                                </MudPaper>
                            }
                        </div>
                    }

                </MudItem>

                <MudItem xs="12" md="5" lg="4">
                    <MudPaper Elevation="0" Class="info-panel pa-6 rounded-xl shadow-sm">
                        <div class="d-flex align-center mb-6">
                            <div class="icon-circle bg-green-light mr-4">
                                <MudIcon Icon="@Icons.Material.Filled.CurrencyRuble" Color="Color.Success" Size="Size.Medium" />
                            </div>
                            <div>
                                <MudText Typo="Typo.caption" Class="text-secondary text-uppercase font-weight-bold mb-1 d-block">Средний чек</MudText>
                                <MudText Typo="Typo.h5" Class="font-weight-bold">
                                    @(Restaurant.AverageCheck != null && Restaurant.AverageCheck.Amount > 0 ? $"{Restaurant.AverageCheck.Amount:N0} ₽" : "Не указан")
                                </MudText>
                            </div>
                        </div>

                        <MudDivider Class="mb-6" />

                        <div class="d-flex align-start mb-6">
                            <div class="icon-circle bg-blue-light mr-4 mt-1">
                                <MudIcon Icon="@Icons.Material.Filled.Place" Color="Color.Primary" />
                            </div>
                            <div>
                                <MudText Typo="Typo.caption" Class="text-secondary text-uppercase font-weight-bold mb-1 d-block">Адрес</MudText>
                                <MudText Typo="Typo.body1" Class="font-weight-bold mb-1">
                                    @Restaurant.Address?.FullAddress
                                </MudText>
                                <MudLink Href="@GetMapLink()" Target="_blank" Underline="Underline.Always" Color="Color.Primary" Class="font-weight-bold">
                                    Показать на карте
                                </MudLink>
                            </div>
                        </div>

                        <div class="d-flex align-start mb-6">
                            <div class="icon-circle bg-blue-light mr-4 mt-1">
                                <MudIcon Icon="@Icons.Material.Filled.Phone" Color="Color.Primary" />
                            </div>
                            <div>
                                <MudText Typo="Typo.caption" Class="text-secondary text-uppercase font-weight-bold mb-1 d-block">Контакты</MudText>
                                <MudText Typo="Typo.body1" Class="font-weight-bold">
                                    @(!string.IsNullOrEmpty(Restaurant.PhoneNumber) ? Restaurant.PhoneNumber : "-")
                                </MudText>
                                @if (!string.IsNullOrEmpty(Restaurant.Email))
                                {
                                    <MudText Typo="Typo.body2" Class="text-secondary mt-1 d-block" Style="word-break: break-all;">@Restaurant.Email</MudText>
                                }
                            </div>
                        </div>

                        <MudDivider Class="mb-6" />

                        <div class="d-flex align-start">
                            <div class="icon-circle bg-blue-light mr-4 mt-1">
                                <MudIcon Icon="@Icons.Material.Filled.AccessTime" Color="Color.Primary" />
                            </div>
                            <div style="width: 100%;">
                                <MudText Typo="Typo.caption" Class="text-secondary text-uppercase font-weight-bold mb-3 d-block">Режим работы</MudText>

                                @if (Restaurant.OpenHours != null && Restaurant.OpenHours.Any())
                                {
                                    var today = DateTime.Now.DayOfWeek;
                                    var isOpenNow = IsRestaurantOpenNow(Restaurant.OpenHours);

                                    <div class="d-flex align-center mb-4 pa-2 rounded-lg" style="background-color: @(isOpenNow ? "rgba(22, 163, 74, 0.08)" : "rgba(239, 68, 68, 0.08)");">
                                        <MudIcon Icon="@Icons.Material.Filled.Circle"
                                                 Size="Size.Small"
                                                 Color="@(isOpenNow ? Color.Success : Color.Error)"
                                                 Class="mr-2"
                                                 Style="font-size: 12px;" />
                                        <MudText Typo="Typo.body1" Color="@(isOpenNow? Color.Success: Color.Error)" Class="font-weight-bold">
                                            @(isOpenNow ? "Сейчас открыто" : "Сейчас закрыто")
                                        </MudText>
                                    </div>

                                    <div class="schedule-list">
                                        @foreach (var daySchedule in GetSortedSchedule(Restaurant.OpenHours))
                                        {
                                            bool isToday = daySchedule.DayOfWeek == today;

                                            <div class="d-flex align-center py-2 @(isToday ? "current-day" : null)">

                                                <MudText Typo="Typo.body1" Class="@(isToday ? "font-weight-bold text-primary" : "text-secondary font-weight-medium")">
                                                    @GetRussianDayName(daySchedule.DayOfWeek)
                                                </MudText>

                                                <MudText Typo="Typo.body1"
                                                         Class="@(isToday ? "font-weight-bold text-dark" : "text-dark font-weight-medium")"
                                                         Style="white-space: nowrap; font-variant-numeric: tabular-nums;">
                                                    @if (daySchedule.IsClosed)
                                                    {
                                                        <span style="color: var(--mud-palette-error);">Выходной</span>
                                                    }
                                                    else
                                                    {
                                                        @($"{daySchedule.OpenTime:HH:mm} — {daySchedule.CloseTime:HH:mm}")
                                                    }
                                                </MudText>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body1" Class="text-secondary">Время не указано</MudText>
                                }
                            </div>
                        </div>

                    </MudPaper>
                </MudItem>
            </MudGrid>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public RestaurantDto Restaurant { get; set; } = default!;

    private List<ReviewDto>? _reviews;
    private ReviewDto? _myExistingReview;
    private Guid? _currentUserId;

    private int _reviewRating = 0;
    private string? _reviewComment;
    private decimal? _userAverageCheck;
    private bool _isSubmitting = false;

    private int _selectedIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        _selectedIndex = 0;
        await LoadReviewsAndUser();
    }

    private void Close() => MudDialog.Close();

    private void NextImage()
    {
        if (Restaurant.Images == null || !Restaurant.Images.Any()) return;
        _selectedIndex = (_selectedIndex + 1) % Restaurant.Images.Count;
    }

    private void PrevImage()
    {
        if (Restaurant.Images == null || !Restaurant.Images.Any()) return;
        var count = Restaurant.Images.Count;
        _selectedIndex = (_selectedIndex - 1 + count) % count;
    }

    private string GetMapLink()
    {
        if (Restaurant.Location != null)
        {
            var lat = Restaurant.Location.Latitude.ToString(CultureInfo.InvariantCulture);
            var lon = Restaurant.Location.Longitude.ToString(CultureInfo.InvariantCulture);
            return $"https://yandex.ru/maps/?pt={lon},{lat}&z=15&l=map";
        }
        return "#";
    }

    private IEnumerable<OpenHoursDto> GetSortedSchedule(IEnumerable<OpenHoursDto> hours)
    {
        return hours.OrderBy(h => h.DayOfWeek == DayOfWeek.Sunday ? 7 : (int)h.DayOfWeek);
    }

    private string GetRussianDayName(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "Пн.",
            DayOfWeek.Tuesday => "Вт.",
            DayOfWeek.Wednesday => "Ср.",
            DayOfWeek.Thursday => "Чт.",
            DayOfWeek.Friday => "Пт.",
            DayOfWeek.Saturday => "Сб.",
            DayOfWeek.Sunday => "Вс.",
            _ => day.ToString()
        };
    }

    private bool IsRestaurantOpenNow(IEnumerable<OpenHoursDto> hours)
    {
        var now = DateTime.Now;
        var todaySchedule = hours.FirstOrDefault(h => h.DayOfWeek == now.DayOfWeek);

        if (todaySchedule == null || todaySchedule.IsClosed)
            return false;

        var currentTime = TimeOnly.FromDateTime(now);

        if (todaySchedule.CloseTime < todaySchedule.OpenTime)
            return currentTime >= todaySchedule.OpenTime;

        return currentTime >= todaySchedule.OpenTime && currentTime <= todaySchedule.CloseTime;
    }

    private async Task LoadReviewsAndUser()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userClaims = authState.User;
            var userIdStr = userClaims.FindFirst("sub")?.Value ?? userClaims.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (Guid.TryParse(userIdStr, out var uid))
                _currentUserId = uid;

            var result = await RestaurantService.GetReviewsByRestaurantAsync(Restaurant.RestaurantId);
            if (result != null)
            {
                _reviews = result.Items
                    .Where(r => r.RestaurantId == Restaurant.RestaurantId)
                    .ToList();

                if (_currentUserId.HasValue)
                    _myExistingReview = _reviews.FirstOrDefault(r => r.UserId == _currentUserId.Value);
            }
            else
                _reviews = new List<ReviewDto>();
        }
        catch
        {
            _reviews = new List<ReviewDto>();
        }
    }

    private async Task SubmitReviewAsync()
    {
        if (_reviewRating == 0)
        {
            Snackbar.Add("Пожалуйста, поставьте оценку", Severity.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(_reviewComment))
        {
            Snackbar.Add("Пожалуйста, напишите пару слов", Severity.Warning);
            return;
        }

        _isSubmitting = true;

        try
        {
            if (_currentUserId == null)
            {
                Snackbar.Add("Ошибка авторизации", Severity.Error);
                return;
            }

            MoneyDto? moneyDto = null;
            if (_userAverageCheck.HasValue)
                moneyDto = new MoneyDto(_userAverageCheck.Value, "RUB");

            var dto = new CreateReviewDto(
                RestaurantId: Restaurant.RestaurantId,
                UserId: _currentUserId.Value,
                Rating: (decimal)_reviewRating,
                AverageCheck: moneyDto,
                Comment: _reviewComment
            );

            var result = await RestaurantService.CreateReviewAsync(dto);

            if (result)
            {
                Snackbar.Add("Отзыв успешно отправлен!", Severity.Success);

                _reviewRating = 0;
                _reviewComment = string.Empty;
                _userAverageCheck = null;

                await LoadReviewsAndUser();
            }
            else
                Snackbar.Add("Не удалось отправить отзыв.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
