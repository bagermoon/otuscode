@page "/user-claims"
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using RestoRate.Auth.Authorization
@using RestoRate.Contracts.Restaurant.DTOs
@using RestoRate.BlazorDashboard.Services
@attribute [Authorize]

@inject RestaurantWebService RestaurantService
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Профиль пользователя</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">

    <MudPaper Elevation="3" Class="pa-8 rounded-xl mb-6 d-flex align-center gap-6 relative overflow-hidden">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #594ae2 0%, #ff4081 100%);"></div>

        <MudAvatar Style="height: 100px; width: 100px; font-size: 2.5rem;" Color="Color.Primary" Variant="Variant.Filled" Class="elevation-4">
            @GetInitials()
        </MudAvatar>

        <div>
            <MudText Typo="Typo.h4" Class="font-weight-bold">@GetName()</MudText>
            <div class="d-flex align-center gap-2 mt-1">
                <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    @GetRole()
                </MudText>
                @if (IsEmailVerified())
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.CheckCircle" Class="ml-2">Email подтвержден</MudChip>
                }
            </div>
        </div>
    </MudPaper>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">

        <MudTabPanel Text="Основная информация" Icon="@Icons.Material.Filled.Person">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudField Label="Email" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email">
                        @GetClaimValue("email")
                    </MudField>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudField Label="Логин" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AccountCircle">
                        @GetClaimValue("preferred_username")
                    </MudField>
                </MudItem>

                <MudItem xs="12">
                    <MudField Label="ID Пользователя" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Fingerprint">
                        @GetClaimValue("sub")
                    </MudField>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <MudTabPanel Text="Мои рестораны" Icon="@Icons.Material.Filled.RestaurantMenu">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6" Class="font-weight-bold">Управление заведениями</MudText>
                <AuthorizeView Policy="@PolicyNames.RequireAdminRole">
                    <Authorized Context="auth">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => Nav.NavigateTo("/restaurants/add"))">
                            Добавить ресторан
                        </MudButton>
                    </Authorized>
                </AuthorizeView>
            </div>

            @if (_isLoadingRestaurants)
            {
                <div class="d-flex justify-center my-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (!_myRestaurants.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    У вас пока нет добавленных ресторанов.
                </MudAlert>
            }
            else
            {
                <MudTable Items="@_myRestaurants" Hover="true" Elevation="0" Class="rounded-lg border-solid border mud-border-lines-default">
                    <HeaderContent>
                        <MudTh>Название</MudTh>
                        <MudTh>Адрес</MudTh>
                        <MudTh>Статус</MudTh>
                        <MudTh>Рейтинг</MudTh>
                        <MudTh Style="text-align: right">Действия</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="restaurant">
                        <MudTd DataLabel="Название" Class="font-weight-bold">
                            @restaurant.Name
                        </MudTd>
                        <MudTd DataLabel="Адрес">
                            <MudText Typo="Typo.body2" Class="text-secondary">@restaurant.Address?.FullAddress</MudText>
                        </MudTd>
                        <MudTd DataLabel="Статус">
                            @GetStatusChip(restaurant.RestaurantStatus)
                        </MudTd>
                        <MudTd DataLabel="Рейтинг">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Class="mr-1" />
                                <MudText Typo="Typo.body2" Class="font-weight-bold">@(restaurant.Rating?.AverageRating.ToString("0.0") ?? "0.0")</MudText>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Действия" Style="text-align: right">
                            <AuthorizeView Policy="@PolicyNames.RequireAdminRole">
                                <Authorized Context="auth">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small" Title="Редактировать" OnClick="@(() => Nav.NavigateTo($"/restaurants/edit/{restaurant.RestaurantId}"))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" Title="Удалить" OnClick="@(() => ConfirmDeleteAsync(restaurant))" />
                                </Authorized>
                            </AuthorizeView>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudTabPanel>

        <MudTabPanel Text="Все данные (Debug)" Icon="@Icons.Material.Filled.Code">
            <MudTable Items="@_claims" Hover="true" Striped="true" Dense="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Тип (Key)</MudTh>
                    <MudTh>Значение (Value)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Тип">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Type</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.ValueType.Split('#').Last()</MudText>
                    </MudTd>
                    <MudTd DataLabel="Значение">
                        <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #333;">@context.Value</code>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudTabPanel>

    </MudTabs>

</MudContainer>

@code {
    private IEnumerable<Claim> _claims = Enumerable.Empty<Claim>();
    private ClaimsPrincipal _user = new();
    private List<RestaurantDto> _myRestaurants = new();
    private bool _isLoadingRestaurants = true;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthState == null) return;

        var authState = await AuthState;
        _user = authState.User;
        _claims = _user.Claims.OrderBy(c => c.Type);

        await LoadUserRestaurantsAsync();
    }

    private async Task LoadUserRestaurantsAsync()
    {
        _isLoadingRestaurants = true;
        try
        {
            var userId = GetClaimValue("sub");
            if (!string.IsNullOrEmpty(userId))
            {
                var result = await RestaurantService.GetUserRestaurantsByOwnerAsync(userId);
                _myRestaurants = result;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка загрузки ресторанов: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingRestaurants = false;
        }
    }

    private async Task ConfirmDeleteAsync(RestaurantDto restaurant)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Подтверждение",
            $"Вы действительно хотите удалить ресторан «{restaurant.Name}»?",
            yesText: "Удалить", cancelText: "Отмена");

        if (result == true)
        {
            try
            {
                var success = await RestaurantService.DeleteRestaurantAsync(restaurant.RestaurantId);
                if (success)
                {
                    _myRestaurants.Remove(restaurant);
                    Snackbar.Add("Ресторан успешно удален", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Не удалось удалить ресторан", Severity.Error);
                }
            }
            catch (Exception)
            {
                Snackbar.Add("Произошла ошибка при удалении", Severity.Error);
            }
        }
    }

    private RenderFragment GetStatusChip(string status) => builder =>
    {
        var (color, text) = status switch
        {
            "Published" => (Color.Success, "Опубликован"),
            "OnModeration" => (Color.Warning, "На модерации"),
            "Draft" => (Color.Default, "Черновик"),
            "Rejected" => (Color.Error, "Отклонен"),
            "Archived" => (Color.Dark, "В архиве"),
            _ => (Color.Default, status)
        };

        builder.OpenComponent<MudChip<string>>(0);
        builder.AddAttribute(1, "Color", color);
        builder.AddAttribute(2, "Size", Size.Small);
        builder.AddAttribute(3, "Variant", Variant.Filled);
        builder.AddAttribute(4, "ChildContent", (RenderFragment)(b => b.AddContent(5, text)));
        builder.CloseComponent();
    };

    private string GetName()
    {
        var name = GetClaimValue("name");
        return string.IsNullOrEmpty(name) ? (_user.Identity?.Name ?? "Гость") : name;
    }

    private string GetInitials()
    {
        var name = GetName();
        if (string.IsNullOrWhiteSpace(name)) return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private string GetRole() => _user.FindFirst(ClaimTypes.Role)?.Value ?? "Пользователь";

    private bool IsEmailVerified() => GetClaimValue("email_verified")?.ToLower() == "true";

    private string? GetClaimValue(string type)
    {
        return _user.FindFirst(type)?.Value
               ?? _user.FindFirst($"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/{type}")?.Value
               ?? _user.FindFirst($"http://schemas.microsoft.com/ws/2008/06/identity/claims/{type}")?.Value;
    }
}
