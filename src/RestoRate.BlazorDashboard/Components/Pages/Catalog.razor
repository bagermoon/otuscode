@page "/catalog"
@page "/catalog/restaurant/{Id:guid}"
@using RestoRate.BlazorDashboard.Components.Shared
@using RestoRate.BlazorDashboard.Services
@using RestoRate.RestaurantService.Application.UseCases.Restaurants.GetAll
@using Microsoft.AspNetCore.WebUtilities
@using RestoRate.Contracts.Restaurant.DTOs

@inject RestaurantWebService RestaurantService
@inject IDialogService DialogService
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>RestoRate - Каталог</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
    <RestaurantFilters @ref="filters" OnFiltersChanged="Reload" />

    @if (pagedRestaurants is not null && pagedRestaurants.Items.Any())
    {
        <MudGrid Spacing="3" Class="mt-4">
            @foreach (var r in pagedRestaurants.Items)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <SearchCard Restaurant="r" OnOpen="@(() => OpenDetails(r.RestaurantId, r))" />
                </MudItem>
            }
        </MudGrid>

        <div class="d-flex justify-center mt-8">
            <MudPagination Selected="@currentPage"
                           SelectedChanged="ChangePage"
                           Count="@pagedRestaurants.TotalPages"
                           ShowFirstButton="true"
                           ShowLastButton="true"
                           Color="Color.Primary"
                           Variant="Variant.Outlined"
                           Shape="Rounded.Circle" />
        </div>
    }
    else if (loading)
    {
        <div class="d-flex justify-center py-10">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </div>
    }
    else
    {
        <div class="d-flex flex-column align-center justify-center py-16">
            <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="Size.Large" Color="Color.Secondary" Style="font-size: 64px; opacity: 0.5;" />
            <MudText Typo="Typo.h5" Class="mt-4 text-secondary">Рестораны не найдены</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ResetAll">Сбросить фильтры</MudButton>
        </div>
    }
</MudContainer>

@code {
    [Parameter] public Guid? Id { get; set; }

    private Contracts.Common.PagedResult<RestaurantDto>? pagedRestaurants;
    private bool loading = true;
    private int currentPage = 1;
    private RestaurantFilters? filters;
    private IDialogReference? _dialogReference;

    private string? _initialSearchTerm;
    private string? _initialCuisine;

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("cuisineType", out var cuisineType))
            _initialCuisine = cuisineType;

        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("searchTerm", out var searchTerm))
            _initialSearchTerm = searchTerm;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (filters != null && (!string.IsNullOrEmpty(_initialCuisine) || !string.IsNullOrEmpty(_initialSearchTerm)))
                await filters.SetValues(_initialSearchTerm, _initialCuisine);

            await Load();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id.HasValue && _dialogReference == null)
        {
            await Task.Yield();

            var restaurant = pagedRestaurants?.Items.FirstOrDefault(x => x.RestaurantId == Id.Value);

            if (restaurant == null)
                restaurant = await RestaurantService.GetRestaurantByIdAsync(Id.Value);

            if (restaurant != null)
                _ = ShowDialogInternal(restaurant);
        }
        else if (!Id.HasValue && _dialogReference != null)
        {
            _dialogReference.Close();
            _dialogReference = null;
        }
    }

    private async Task Reload()
    {
        currentPage = 1;
        await Load();
    }

    private async Task ResetAll()
    {
        if (filters != null) await filters.ResetFilters();
    }

    private async Task ChangePage(int page)
    {
        currentPage = page;
        await Load();
    }

    private async Task Load()
    {
        loading = true;
        StateHasChanged();

        var f = filters?.GetFilters() ?? (_initialSearchTerm, _initialCuisine, null);

        pagedRestaurants = await RestaurantService.GetRestaurantsAsync(
            currentPage,
            12,
            f.SearchTerm,
            f.CuisineType,
            f.Tag);

        loading = false;
        StateHasChanged();

        if (Id.HasValue && _dialogReference == null)
            _ = OnParametersSetAsync();
    }

    private void OpenDetails(Guid restaurantId, RestaurantDto restaurant)
    {
        Nav.NavigateTo($"/catalog/restaurant/{restaurantId}");
    }

    private async Task ShowDialogInternal(RestaurantDto restaurant)
    {
        var parameters = new DialogParameters<RestaurantDetailsDialog> { { x => x.Restaurant, restaurant } };
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            NoHeader = true
        };

        var dialog = await DialogService.ShowAsync<RestaurantDetailsDialog>("Details", parameters, options);
        _dialogReference = dialog;

        var result = await dialog.Result;

        _dialogReference = null;

        if (Nav.Uri.Contains("/restaurant/"))
            Nav.NavigateTo("/catalog", replace: false);
    }
}
