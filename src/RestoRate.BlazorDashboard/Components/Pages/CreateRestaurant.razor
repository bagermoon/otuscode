@page "/restaurants/add"
@using RestoRate.Contracts.Restaurant.DTOs.CRUD
@using RestoRate.Contracts.Restaurant.DTOs
@using RestoRate.Contracts.Common.Dtos
@using RestoRate.SharedKernel.Enums
@using RestoRate.BlazorDashboard.Services
@using Microsoft.AspNetCore.Authorization
@using System.Text.RegularExpressions

@attribute [Authorize]
@inject RestaurantWebService RestaurantService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<PageTitle>Добавить ресторан</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8 mb-16">
    <div class="d-flex align-center mb-6">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Nav.NavigateTo("/"))" Color="Color.Inherit" Class="mr-3" />
        <MudText Typo="Typo.h4" Class="font-weight-bold mud-text-primary">Новое заведение</MudText>
    </div>

    <MudPaper Class="rr-cloud pa-8" Elevation="0">
        <EditForm Model="@_formModel" OnValidSubmit="SubmitAsync">
            <DataAnnotationsValidator />

            <MudGrid Spacing="4">

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="font-weight-bold">Основное</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_formModel.Name" Label="Название" Variant="Variant.Outlined" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Store" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_formModel.Description" Label="Описание" Lines="3" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_formModel.PhoneNumber"
                                  Label="Телефон"
                                  Variant="Variant.Outlined"
                                  Mask="@(new PatternMask("(000) 000-00-00"))"
                                  Placeholder="(999) 000-00-00"
                                  Adornment="Adornment.Start"
                                  AdornmentText="+7"
                                  Style="padding-left: 10px;" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_formModel.Email" Label="Email" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" />
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Class="font-weight-bold">Локация</MudText>
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudTextField @bind-Value="_formModel.AddressFull" Label="Улица, город" Variant="Variant.Outlined" HelperText="Например: г. Москва, ул. Ленина" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="_formModel.AddressHouse" Label="Дом" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="6">
                    <MudNumericField @bind-Value="_formModel.Latitude"
                                     Label="Широта"
                                     Variant="Variant.Outlined"
                                     Step="0.000001"
                                     Format="0.000000" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField @bind-Value="_formModel.Longitude"
                                     Label="Долгота"
                                     Variant="Variant.Outlined"
                                     Step="0.000001"
                                     Format="0.000000" />
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Class="font-weight-bold">Детали</MudText>
                </MudItem>

                <MudItem xs="6">
                    <MudNumericField @bind-Value="_formModel.AvgCheckAmount"
                                     Label="Средний чек"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     HideSpinButtons="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.CurrencyRuble" />
                </MudItem>
                <MudItem xs="6">
                    <MudSelect @bind-Value="_formModel.Currency" Label="Валюта" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("RUB")">RUB</MudSelectItem>
                        <MudSelectItem Value="@("USD")">USD</MudSelectItem>
                        <MudSelectItem Value="@("EUR")">EUR</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Class="font-weight-bold mb-4">Режим работы</MudText>

                    <div class="d-flex flex-column gap-2">
                        @foreach (var day in _formModel.Schedule)
                        {
                            <MudPaper Elevation="0" Class="d-flex align-center pa-3 rounded-lg border-solid border mud-border-lines-default" Style="@(!day.IsOpen ? "opacity: 0.6; background-color: var(--mud-palette-background-grey);" : "")">
                                <div style="width: 180px;">
                                    <MudSwitch T="bool" @bind-Checked="day.IsOpen" Color="Color.Success" Label="@day.DayName" />
                                </div>

                                @if (day.IsOpen)
                                {
                                    <div class="d-flex gap-4 flex-grow-1">
                                        <MudTimePicker @bind-Time="day.OpenTime" Label="Открытие" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                        <MudTimePicker @bind-Time="day.CloseTime" Label="Закрытие" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                    </div>
                                }
                                else
                                {
                                    <div class="flex-grow-1">
                                        <MudText Color="Color.Error" Class="font-weight-medium">Выходной</MudText>
                                    </div>
                                }
                            </MudPaper>
                        }
                    </div>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Class="font-weight-bold">Характеристики</MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect T="string" Label="Кухни" MultiSelection="true" @bind-SelectedValues="_formModel.SelectedCuisines" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        @foreach (var cuisine in CuisineType.List.OrderBy(c => c.RussianName))
                        {
                            <MudSelectItem T="string" Value="@cuisine.Name">@cuisine.RussianName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_formModel.TagsInput" Label="Теги (через запятую)" Variant="Variant.Outlined" HelperText="WiFi, Терраса, Детская комната" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Tag" />
                </MudItem>

                <MudItem xs="12">
                    <div class="d-flex justify-space-between align-center mb-2">
                        <MudText>Фотографии (@_formModel.Images.Count)</MudText>
                        <MudButton OnClick="AddImageField" StartIcon="@Icons.Material.Filled.Add" Color="Color.Secondary" Variant="Variant.Text">
                            Добавить URL
                        </MudButton>
                    </div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Первая фотография будет главной.</MudText>
                </MudItem>

                @for (int i = 0; i < _formModel.Images.Count; i++)
                {
                    var index = i;
                    <MudItem xs="12">
                        <div class="d-flex gap-2 align-center">
                            <MudTextField @bind-Value="_formModel.Images[index].Url"
                                          Label="@(index == 0 ? "Главное фото" : $"Фото #{index + 1}")"
                                          Variant="Variant.Outlined"
                                          FullWidth="true" />

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="@(() => RemoveImage(_formModel.Images[index]))" />
                        </div>
                    </MudItem>
                }

                <MudItem xs="12" Class="mt-4 d-flex justify-end">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large" Disabled="@_isSubmitting" Class="rounded-pill px-12 py-3 font-weight-bold">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Отправка...</MudText>
                        }
                        else
                        {
                            <MudText>Создать Ресторан</MudText>
                        }
                    </MudButton>
                </MudItem>

            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private CreateRestaurantFormModel _formModel = new();
    private bool _isSubmitting = false;

    private Dictionary<DayOfWeek, string> _daysMap = new()
    {
        { DayOfWeek.Monday, "Понедельник" },
        { DayOfWeek.Tuesday, "Вторник" },
        { DayOfWeek.Wednesday, "Среда" },
        { DayOfWeek.Thursday, "Четверг" },
        { DayOfWeek.Friday, "Пятница" },
        { DayOfWeek.Saturday, "Суббота" },
        { DayOfWeek.Sunday, "Воскресенье" }
    };

    protected override void OnInitialized()
    {
        var daysOrder = new[] {
        DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday,
        DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday
        };

        foreach (var day in daysOrder)
        {
            _formModel.Schedule.Add(new DayScheduleViewModel
            {
                Day = day,
                DayName = _daysMap[day],
                IsOpen = true
            });
        }

        AddImageField();
    }

    private void AddImageField()
    {
        if (_formModel.Images.Count < 10)
            _formModel.Images.Add(new ImageViewModel());
    }

    private void RemoveImage(ImageViewModel img)
    {
        _formModel.Images.Remove(img);
    }

    private async Task SubmitAsync()
    {
        _isSubmitting = true;
        try
        {
            string rawPhone = _formModel.PhoneNumber ?? "";
            string digitsOnly = Regex.Replace(rawPhone, @"\D", "");

            if (digitsOnly.Length == 11 && (digitsOnly.StartsWith("7") || digitsOnly.StartsWith("8")))
                digitsOnly = digitsOnly.Substring(1);

            var tagsList = _formModel.TagsInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(x => x.Trim())
                .ToList();

            var openHoursList = _formModel.Schedule
                .Select(day => new OpenHoursDto(
                    DayOfWeek: day.Day,
                    OpenTime: day.OpenTime.HasValue ? TimeOnly.FromTimeSpan(day.OpenTime.Value) : new TimeOnly(10, 0),
                    CloseTime: day.CloseTime.HasValue ? TimeOnly.FromTimeSpan(day.CloseTime.Value) : new TimeOnly(23, 0),
                    IsClosed: !day.IsOpen
                ))
                .ToList();

            var validImages = _formModel.Images
                .Where(x => !string.IsNullOrWhiteSpace(x.Url))
                .Select((x, index) => new CreateRestaurantImageDto(
                    Url: x.Url,
                    AltText: null,
                    IsPrimary: index == 0
                ))
                .ToList();

            var dto = new CreateRestaurantDto(
                Name: _formModel.Name,
                Description: _formModel.Description,
                PhoneNumber: digitsOnly,
                Email: _formModel.Email,
                Address: new AddressDto(_formModel.AddressFull, _formModel.AddressHouse),
                Location: new LocationDto(_formModel.Latitude, _formModel.Longitude),
                OpenHours: openHoursList,
                AverageCheck: new MoneyDto(_formModel.AvgCheckAmount, _formModel.Currency),
                CuisineTypes: _formModel.SelectedCuisines.ToList(),
                Tags: tagsList,
                Images: validImages
            );

            var success = await RestaurantService.CreateRestaurantAsync(dto);

            if (success)
            {
                Snackbar.Add("Ресторан успешно отправлен на модерацию!", Severity.Success);
                Nav.NavigateTo("/catalog");
            }
            else
            {
                Snackbar.Add("Ошибка валидации. Проверьте правильность полей.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка соединения: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    public class ImageViewModel
    {
        public string Url { get; set; } = "";
    }

    public class CreateRestaurantFormModel
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
        public string Email { get; set; } = "";
        public string AddressFull { get; set; } = "";
        public string AddressHouse { get; set; } = "";

        public double Latitude { get; set; } = 55.7512;
        public double Longitude { get; set; } = 37.6184;

        public decimal AvgCheckAmount { get; set; }
        public string Currency { get; set; } = "RUB";

        public List<DayScheduleViewModel> Schedule { get; set; } = new();

        public IEnumerable<string> SelectedCuisines { get; set; } = new HashSet<string>();
        public string TagsInput { get; set; } = "";

        public List<ImageViewModel> Images { get; set; } = new();
    }

    public class DayScheduleViewModel
    {
        public DayOfWeek Day { get; set; }
        public string DayName { get; set; } = "";
        public bool IsOpen { get; set; } = true;
        public TimeSpan? OpenTime { get; set; } = new TimeSpan(10, 0, 0);
        public TimeSpan? CloseTime { get; set; } = new TimeSpan(23, 0, 0);
    }
}
